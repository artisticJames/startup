<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Start Up - Login</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="styles.css" />
    <link rel="icon" type="image/svg+xml" href="assets/logo.svg" />
</head>
<body class="login-body">
    <div class="frame">
        <div class="device">
            <div class="content login">
                <header class="login-header">
                    <img class="logo" src="assets/logo.svg" alt="Start Up logo" />
                    <h1>Start Up</h1>
                    <p class="subtitle">Welcome back. Sign in to continue.</p>
                </header>

                <form class="login-form" id="loginForm" novalidate>
                    <label class="input">
                        <span>Email</span>
                        <input type="email" id="email" placeholder="you@example.com" required />
                    </label>
                    <label class="input">
                        <span>Password</span>
                        <input type="password" id="password" placeholder="••••••••" required />
                    </label>
                    <button type="submit" class="primary">Sign In</button>
                    <a class="muted-link" href="forgot.html">Forgot password?</a>
                    <a class="muted-link" href="register.html">Create an account</a>
                </form>
            </div>
        </div>
    </div>

    <script>
    // Check if backend server is running
    async function checkServerStatus() {
        try {
            const response = await fetch('http://localhost:3000/api/health', {
                method: 'GET',
                timeout: 3000
            });
            return response.ok;
        } catch (error) {
            console.log('Backend server not available:', error.message);
            return false;
        }
    }

    const form = document.getElementById('loginForm');
    form.addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const email = document.getElementById('email').value.trim();
        const password = document.getElementById('password').value.trim();
        
        if (!email || !password) {
            alert('Please enter both email and password.');
            return;
        }

        try {
            console.log('Attempting to connect to backend server...');
            // Try to login with backend
            const response = await fetch('http://localhost:3000/api/login', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ email, password })
            });
            
            console.log('Backend response status:', response.status);

            const result = await response.json();

            if (response.ok) {
                // Save user data and token
                console.log('Login successful, saving user data:', result.user);
                console.log('User name from server:', result.user.name);
                console.log('User email from server:', result.user.email);
                localStorage.setItem('userData', JSON.stringify(result.user));
                localStorage.setItem('authToken', result.token);
                
                // Verify data was saved
                const savedData = localStorage.getItem('userData');
                console.log('Saved user data:', savedData);
                const parsedData = JSON.parse(savedData);
                console.log('Parsed saved data - Name:', parsedData.name, 'Email:', parsedData.email);
                
                alert('Login successful!');
                
                // Redirect admin users to admin page
                if (result.user.isAdmin) {
                    window.location.href = 'admin.html';
                } else {
                    window.location.href = 'index.html';
                }
            } else {
                alert(result.error || 'Login failed');
            }
        } catch (error) {
            console.log('Server not available, using fallback login');
            console.log('Error details:', error);
            
            // Check if we have existing user data in localStorage
            const existingUserData = localStorage.getItem('userData');
            if (existingUserData) {
                try {
                    const existingUser = JSON.parse(existingUserData);
                    console.log('Found existing user data:', existingUser);
                    
                    // Use existing user data if it matches the email
                    if (existingUser.email === email) {
                        console.log('Using existing user data for login');
                        localStorage.setItem('userData', JSON.stringify(existingUser));
                        alert('Login successful (using saved data)!');
                        window.location.href = 'index.html';
                        return;
                    }
                } catch (parseError) {
                    console.log('Error parsing existing user data:', parseError);
                }
            }
            
            // Fallback: create demo user data with a proper name
            const nameFromEmail = email.split('@')[0].replace(/[._]/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
            const userData = {
                name: nameFromEmail,
                email: email,
                id: Date.now(),
                verified: true
            };
            console.log('Fallback login, saving user data:', userData);
            localStorage.setItem('userData', JSON.stringify(userData));
            
            // Verify data was saved
            const savedData = localStorage.getItem('userData');
            console.log('Saved user data (fallback):', savedData);
            
            alert('Login successful (demo mode)!');
            window.location.href = 'index.html';
        }
    });
    </script>
</body>
</html>

